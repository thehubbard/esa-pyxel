# ###############
### Pyxel configuration file for CCD detectors
### David Lucsanyi
# ###############

simulation:

#  mode: single
  mode: parametric
#  mode: calibration

  outputs:
    output_folder:    'outputs'
    parametric_plot:
      x:  'detector.image.mean'
      y:  'detector.image.std_deviation'
#      plt_args:
#        xlabel:
#        ylabel: 'sigma'
#        title: 'Parametric analysis'
#        xscale: 'linear'
#        yscale: 'log'
#        grid: true
#        color: green

    calibration_plot:
      champions_plot:
#        plt_args:
#          xlabel:
#          ylabel:
#          title:
#          xscale: 'linear'
#          yscale: 'log'
      population_plot:
#        columns: [16, 2]


  parametric:
    parametric_mode: sequential
#    parametric_mode: embedded
#    parametric_mode: parallel
#    from_file: 'outputs/calibration_champions.out'
#    column_range: [2, 17]
    parameters:
      - key: pipeline.charge_generation.tars.arguments.particle_number
        values: range(2, 10)
        enabled: true
#      - key: pipeline.photon_generation.illumination.arguments.level
#        values: range(0, 200, 50)
#        enabled: true

#      - key:  detector.characteristics.amp
#        values: _
#      - key:  pipeline.charge_transfer.cdm.arguments.tr_p
#        values: [_, _, _, _]
#      - key:  pipeline.charge_transfer.cdm.arguments.nt_p
#        values: [_, _, _, _]
#      - key:  pipeline.charge_transfer.cdm.arguments.sigma_p
#        values: [_, _, _, _]
#      - key:  pipeline.charge_transfer.cdm.arguments.beta_p
#        values: _
#      - key:  detector.environment.temperature
#        values: _

  calibration:
    calibration_mode:  pipeline  #  single_model #

    output_type: pixel # image   # signal
    output_fit_range: [0, 2, 0, 2] #[10, 30, 20, 50] #

    target_data_path: ['data/results.fits']     #  <*.npy> <*.fits> <ascii>
    target_fit_range: [0, 2, 0, 2] #[10, 30, 20, 50]
#    weighting_path: ['data/results.fits']

    fitness_function:
#      func: tests.unittests.test_fitting.custom_fitness_func
      func: pyxel.calibration.fitness.sum_of_abs_residuals
      arguments:

    seed: 132
    algorithm:
      type: sade   # sga  # nlopt
#      nlopt_solver: sbplx  # neldermead
      generations: 5
      population_size: 10
      variant: 2

    parameters:
      - key:  detector.characteristics.amp
        values: _
        logarithmic: false
        boundaries: [1., 10.]
#      - key:  pipeline.charge_transfer.cdm.arguments.tr_p
#        values: [_, _, _, _]
#        logarithmic: true
#        boundaries: [1.e-3, 2.]
#      - key:  pipeline.charge_transfer.cdm.arguments.nt_p
#        values: [_, _, _, _]
#        logarithmic: true
#        boundaries: [1.e-2, 1.e+1]
#      - key:  pipeline.charge_transfer.cdm.arguments.sigma_p
#        values: [_, _, _, _]
#        logarithmic: true
#        boundaries: [1.e-20, 1.e-15]
#      - key:  pipeline.charge_transfer.cdm.arguments.beta_p
#        values: _
#        logarithmic: false
#        boundaries: [0., 1.]
      - key:  detector.environment.temperature
        values: _
        logarithmic: false
        boundaries: [100., 200.]

detector:
  class: pyxel.detectors.ccd.CCD

  geometry:
    class: pyxel.detectors.ccd_geometry.CCDGeometry

    row:   100                   # compulsory
    col:   100                     # compulsory
    total_thickness: 40.0          # um
    pixel_vert_size: 10. #10.0         # um
    pixel_horz_size: 10. #10.0  #30.   # um

  material:
    class: pyxel.detectors.material.Material
    material: 'silicon'
    n_acceptor: 0.0               # cm-3
    n_donor: 0.0                  # cm-3

  environment:
    class: pyxel.detectors.environment.Environment
#      temperature: 300                     # K
#      total_ionising_dose: 0              #
#      total_non_ionising_dose: 0          #

  characteristics:
    class: pyxel.detectors.ccd_characteristics.CCDCharacteristics
    qe: 0.5                 # -
    eta: 0.5                # e/photon
    sv: 1.0e-6              # V/e
    amp: 1.                 # V/V
    a1: 100.                # V/V
    a2: 65536               # DN/V
    fwc: 1000000            # e
    fwc_serial: 1000000     # e
    vg: 1.6200e-10          # cm2
    svg: 1.6200e-10         # cm2
    t: 9.4722e-04           # s
    st: 9.4722e-04          # s
#      bias_voltage: 0.0        # V

pipeline:
  class: pyxel.pipelines.ccd_pipeline.CCDDetectionPipeline

  # -> photons
  photon_generation:
    - name: load_image
      func: pyxel.models.photon_generation.load_image.load_image
      enabled: true
      arguments:
        image_file: outputs/in.fits # data/01.fits
        fit_image_to_det: false
        convert_to_photons: true
    - name: illumination
      func: pyxel.models.photon_generation.illumination.illumination
      enabled: true
      arguments:
          level: 10
    - name: shot_noise
      func: pyxel.models.photon_generation.shot_noise.shot_noise
      enabled: false

  # photons -> photons
  optics:

  # photons -> charge
  charge_generation:

    -
      name: photoelectrons
      func: pyxel.models.charge_generation.photoelectrons.simple_conversion
      enabled: true
    -
      name: tars
      func: pyxel.models.charge_generation.tars.tars.run_tars
      enabled: true
      arguments:
        simulation_mode: cosmic_ray   # snowflakes
        running_mode: stepsize  # stopping  # plotting  # geant4
        particle_type: proton
        initial_energy: 100.   # MeV
        particle_number: 1
        incident_angles:      # rad
        starting_position:    # um
        spectrum_file: 'pyxel/models/charge_generation/tars/data/inputs/proton_L2_solarMax_11mm_Shielding.txt'
    -
      name: charge_injection
      func: pyxel.models.charge_generation.charge_injection.charge_injection
      enabled: false
      arguments:
        input_data_list: #path

  # charge -> charge
  charge_collection:
    -
      name: fixed_pattern_noise
      func: pyxel.models.charge_collection.fix_pattern_noise.fix_pattern_noise
      enabled: false
      arguments:
        pix_non_uniformity: data/non_uniformity_array_normal_random_dist.data
    -
      name: full_well
      func: pyxel.models.charge_collection.full_well.simple_pixel_full_well
      enabled: false
    -
      name: simple_collection
      func: pyxel.models.charge_collection.collection.simple_collection
      enabled: true

  # charge -> charge
  charge_transfer:
    -
      name: cdm
      func: pyxel.models.charge_transfer.cdm.CDM.cdm
      enabled: false
      arguments:
       beta_p: 0.1
       beta_s: 0.3
       parallel_cti: true
       serial_cti: false
       chg_inj: true
       para_transfers: 1552
       tr_p: [0.01]
       tr_s: [0.01]
       nt_p: [1.]
       nt_s: [1.]
       sigma_p: [1.]
       sigma_s: [1.]

  # charge -> signal
  charge_measurement:
    -
      name: simple_measurement
      func: pyxel.models.charge_measurement.measurement.simple_measurement
      enabled: true
    -
      name: output_node_noise
      func: pyxel.models.charge_measurement.readout_noise.output_node_noise
      enabled: false
      arguments:
        std_deviation: 0.0001   # TODO too high

  # signal -> image
  readout_electronics:
    -
      name: simple_amplifier
      func: pyxel.models.readout_electronics.amplification.simple_amplifier
      enabled: true
    -
      name: simple_digitization
      func: pyxel.models.readout_electronics.digitization.simple_digitization
      enabled: true
      arguments:
        data_type: numpy.uint32
